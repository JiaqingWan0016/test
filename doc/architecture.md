# LINKD架构设计文档

## 系统架构

LINKD是一个用于同步IPsec接口和绑定接口信息的Linux程序。系统主要由以下模块组成：

1. 主程序模块 (main.c)
   - 系统初始化和清理
   - 主循环控制
   - 信号处理

2. 配置管理模块 (config.c)
   - 配置文件读取和解析
   - 配置项管理
   - 配置重载

3. Netlink事件处理模块 (netlink.c)
   - Netlink socket初始化
   - 网络接口事件监听
   - 事件处理和分发

4. 定时器模块 (timer.c)
   - 定时任务管理
   - 定期检查接口状态
   - 超时处理

5. 共享内存模块 (shm.c)
   - 共享内存初始化
   - 数据读写操作
   - 进程间通信

6. 日志管理模块 (log.c)
   - 日志系统初始化
   - 日志记录
   - 日志级别控制

7. 接口同步模块 (if_sync.c)
   - 接口状态同步
   - IPsec接口管理
   - 绑定接口状态监控

8. 接口地址管理模块 (if_addr.c)
   - IPv4地址获取
   - IPv6地址获取
   - 地址验证和过滤

## 模块依赖关系

```
main.c
  ├── config.c
  ├── netlink.c
  ├── timer.c
  ├── shm.c
  ├── log.c
  ├── if_sync.c
  └── if_addr.c
```

## 数据流

1. 配置加载流程
   - 读取配置文件
   - 解析配置项
   - 初始化接口绑定关系

2. 事件处理流程
   - 监听网络接口事件
   - 识别绑定接口变化
   - 同步IPsec接口状态
   - 更新共享内存
   - 通知vdcd进程

3. 地址管理流程
   - 获取绑定接口地址
   - 验证地址有效性
   - 更新IPsec接口配置

## 关键数据结构

### 链路信息结构体
```c
struct linkinfo {
    char virtualinterface[PHYSICALIF_LEN];  /* IPsec接口名称 */
    char physical[PHYSICALIF_LEN];          /* 绑定接口名称 */
    uint32_t interfaceip;                   /* IPv4地址 */
    uint32_t netmask;                       /* IPv4掩码 */
    uint32_t ipv6[4];                       /* IPv6地址 */
    uint32_t mtu;                           /* MTU值 */
    uint32_t linkstate;                     /* 链路状态 */
    uint32_t linkpriority;                  /* 链路优先级 */
};
```

### 配置项结构体
```c
struct IFBINDCONF_NAME {
    char if_name[PHYSICALIF_LEN];           /* IPsec接口名称 */
    struct {
        char dev[PHYSICALIF_LEN];           /* 绑定接口名称 */
        uint32_t linkpriority;              /* 链路优先级 */
        uint32_t ip;                        /* 指定IPv4地址 */
        uint32_t ipv6[4];                   /* 指定IPv6地址 */
    } ibc;
};
```

## 核心算法

### 接口状态同步算法
1. 检测绑定接口状态变化
2. 查找对应的IPsec接口配置
3. 获取绑定接口地址信息
4. 更新IPsec接口配置
5. 执行接口down/up操作
6. 更新共享内存数据
7. 通知vdcd进程

### 地址获取算法
1. 使用netlink机制获取接口地址
2. 过滤无效地址（如链路本地地址）
3. 验证地址有效性
4. 更新地址信息

## 错误处理机制

1. 初始化错误处理
   - 模块初始化失败时清理已分配资源
   - 记录详细错误日志
   - 优雅退出程序

2. 运行时错误处理
   - 捕获并处理异常情况
   - 记录错误日志
   - 尝试恢复系统状态

3. 资源管理
   - 及时释放不再使用的资源
   - 防止内存泄漏
   - 确保系统稳定性

## 性能优化

1. 事件处理优化
   - 使用事件驱动模式
   - 避免不必要的轮询
   - 优化事件处理流程

2. 资源使用优化
   - 合理分配内存
   - 优化共享内存访问
   - 减少系统调用

3. 并发处理
   - 使用信号处理机制
   - 避免死锁
   - 保证数据一致性

## 安全考虑

1. 权限控制
   - 使用root权限运行
   - 限制文件访问权限
   - 保护配置文件

2. 数据安全
   - 验证输入数据
   - 防止缓冲区溢出
   - 保护敏感信息

3. 系统安全
   - 防止资源耗尽
   - 限制系统调用
   - 监控异常行为 