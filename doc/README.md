# LINKD 项目文档

## 项目概述
LINKD是一个Linux程序，用于同步IPsec接口和绑定接口信息。该程序通过netlink机制监控网络接口状态变化，并将物理接口的IP地址、掩码和状态同步到对应的IPsec接口。

## 功能特性
1. 接口状态监控
   - 监控物理接口的up/down状态
   - 监控接口IP地址变化
   - 监控接口MTU变化

2. 地址管理
   - 支持IPv4地址和掩码管理
   - 支持IPv6地址管理（排除链路本地地址）
   - 支持指定地址匹配

3. 接口同步
   - 将物理接口信息同步到IPsec接口
   - 自动执行接口down/up操作
   - 执行whack命令更新IPsec状态

4. 配置管理
   - 支持从配置文件读取接口绑定信息
   - 支持动态更新配置

## 目录结构
```
.
├── src/                    # 源代码目录
│   ├── main.c             # 主程序入口
│   ├── config.c           # 配置管理模块
│   ├── netlink.c          # netlink事件处理模块
│   ├── timer.c            # 定时任务模块
│   ├── shm.c              # 共享内存管理模块
│   ├── log.c              # 日志管理模块
│   ├── if_sync.c          # 接口同步模块
│   └── if_addr.c          # 接口地址管理模块
├── include/               # 头文件目录
│   ├── linkd.h           # 主头文件
│   ├── config.h          # 配置相关定义
│   ├── netlink.h         # netlink相关定义
│   ├── timer.h           # 定时任务相关定义
│   ├── shm.h             # 共享内存相关定义
│   ├── log.h             # 日志相关定义
│   ├── if_sync.h         # 接口同步相关定义
│   └── if_addr.h         # 接口地址相关定义
├── doc/                   # 文档目录
│   ├── README.md         # 项目说明文档
│   ├── architecture.md   # 架构设计文档
│   └── api.md            # API文档
└── Makefile              # 编译配置文件
```

## 编译说明
1. 依赖项
   - gcc编译器
   - make工具
   - Linux系统头文件

2. 编译命令
```bash
make
```

3. 安装命令
```bash
make install
```

## 配置说明
配置文件格式示例：
```json
{
    "bindings": [
        {
            "physical": "eth0",
            "virtual": "ipsec0",
            "priority": 1,
            "ipv4": "192.168.1.100",
            "ipv6": "2001:db8::1"
        }
    ]
}
```

## 运行说明
1. 启动命令
```bash
linkd
```

2. 日志查看
```bash
tail -f /var/log/linkd.log
```

## 注意事项
1. 需要root权限运行
2. 确保系统支持netlink机制
3. 确保IPsec服务已正确配置
4. 建议在系统启动时自动运行

## 常见问题
1. 权限问题
   - 确保以root权限运行
   - 检查日志文件权限

2. 接口同步失败
   - 检查物理接口是否存在
   - 检查IPsec接口配置
   - 查看系统日志

3. 地址获取失败
   - 检查网络连接
   - 检查接口状态
   - 查看详细日志

## 维护说明
1. 日志轮转
   - 日志文件大小超过20MB时自动轮转
   - 保留最近的5个日志文件

2. 错误处理
   - 所有错误都会记录到日志
   - 关键错误会触发告警

3. 性能优化
   - 使用共享内存减少进程间通信开销
   - 优化netlink消息处理
   - 合理设置定时任务间隔 